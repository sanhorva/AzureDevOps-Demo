trigger:
- azure

pool:
    vmImage: 'ubuntu-latest'

stages:
- stage: BuildApp
  jobs:
  - job: BuildPushImage
    steps: 
    - task: AzureCLI@2
      displayName: 'Build and push Docker image'
      inputs:
        azureSubscription: 'ZEISSgroup-DI05-ASM-Learning'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        addSpnToEnvironment: true
        inlineScript: |
          ACR_NAME=crsanyi
          IMAGE_NAME=mywebapp:v1
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME -f Dockerfile .
          az acr login --name $ACR_NAME
          docker tag $ACR_NAME.azurecr.io/$IMAGE_NAME $ACR_NAME.azurecr.io/$IMAGE_NAME:v1
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME
          
- stage: ScanImage
  jobs:
  - job: ScanImage
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: 'ZEISSgroup-DI05-ASM-Learning'
        scriptType: 'pscore'
        scriptLocation: 'scriptPath'
        scriptPath: '$(System.DefaultWorkingDirectory)/scripts/ImageScanSummaryAssessmentGate.ps1'
        arguments: '-registryName crsanyi -repository mywebapp -tag crsanyi.azurecr.io/mywebapp:v1'